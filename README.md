# Welcome to my project...
A small project for organizations where they can opt for a monthly request limit, and based on the limit they can access the request API. This project is the POC for the Subscription Handling.


## Database

This project is using Postgres, and below are the db details.

Tables:

```text
1. organizations

- organization_id       - primary key
- email                 - unique
- name
- time_stamp
```

```text
2. organization_subscriptions

- subscription_id       - primary key
- organization_id       - foreign key
- api_key               - unique
- subscription_plan
- monthly_limit
```

```text
3. requests

- request_id            - primary key
- organization_id       - foreign key
- time_stamp
```

Indexes:

```text
1. idx_organization_request_count - (organization_id, time_stamp)
```

Views:

```text
1. view_organization_subscription_details

- organization_id
- name
- email
- subscription_plan
- api_key
- monthly_limit
- time_stamp
```

## Engineering Design Decisions
1. Separated `organization` table and `organization_subscriptions` table. As we may need to change subscription details. To maintain the safety.
2. Created index on the `requests` table for efficiently getting the `monthly request count`.
3. Created `view` to remove the redundancy of using the same join and the same information everywhere.
4. Here we could have used `Materialized Views` for the `monthly request count` as a caching. But we need to refresh the view periodically to maintain consistency.
5. Middleware is used to handle the `monthly limit` so we can reuse the functionality.
6. In middleware I have attached `organization data` to the request object so we can use it in any controller later. 
7. `apiKeyActual` is generated and hashed using bcrypt. The `apiKeyHashed` is stored in database.
   Then `userApiKey` is generated by _appending organizationID to apiKeyActual_. and given to the user.
   When user sends userApiKey we again extract *apiKeyActual* and *organizationID* from the same and check for the correctness.
   In middleware the get organization details with *apiKeyHashed* and validate the key.
   This flow ensures the apiKeys are stored in the database is deferent than given to the user. So no one can recreate the same key.
8. Used `row level lock` for managing the concurrency in the project as multiple read, inserts may cause problems.



## Features
- _Register organization_
- _Admin dashboard_: admin can see all organization details.
- _Organization details_: this api has a monthly limit.


## Useful commands

The project makes use of node and its package manager to help you out carrying some common tasks such as running a project.

### Install dependencies

```console
$ yarn
```

### Run the application

Run the application which will be listening on port `8080`. There are two ways to run the application.

- Run the application with the current code

  ```console
  $ yarn start
  ```

- Run the application with reload on save

  ```console
  $ yarn dev
  ```


## API's

Below is a list of API endpoints with their respective input and output. Please note that the application needs to be running for the following endpoints to work.

#### Register organization

Endpoint

```text
POST api/v1/organization
```

Example of body

```json
{
    "name": <organizationName>,
    "email": <organizationEmail>,
    "subscriptionPlan": <subscriptionPlan>,
    "limit": <monthlyLimit>
}
```

Parameters

| Parameter          | Required | Description                                   | Options / Examples             |
| ------------------ | -------- | --------------------------------------------- | ------------------------------ |
| `name`             | Yes      | Name of an organization                       | `IMB`                          |
| `email`            | Yes      | Email of organization or a person registering | `akshay@imb.com`               |
| `subscriptionPlan` | Yes      | Subscription plan for the monthly limit       | {`basic`, `advance`, `custom`} |
| `limit`            | Optional | Request limit number                          | Positive Integer - `13`        |


Example of output - when the organization registered successfully

`HTTP Status Code: 201`

```json
{
    "info": "Organization registered successfully!",
    "data": {
        "organizationID": 1,
        "apiKey": "yT4mCk25dC:1"
    }
}
```

Example of output - when entering the wrong plan

`HTTP Status Code: 400`

```json
{
    "info": "Unknown subscription plan! Please enter the correct plan.",
    "data": null
}
```

Example of output - on internal error

`HTTP Status Code: 500`

```json
{
    "info": "Something went wrong. An error has occurred.",
    "data": null
}
```


#### Admin dashboard

Endpoint

```text
GET api/v1/dashboard
```

Example of output - no data

`HTTP Status Code: 404`

```json
{
    "info": "No data found!",
    "data": []
}
```

Example of output - when details fetched

`HTTP Status Code: 200`

```json
{
    "info": "Organization list fetched successfully!",
    "data": [
        {
            "organization_id": 1,
            "name": "JNV",
            "email": "akshay@jnv.com",
            "subscription_plan": "basic",
            "monthly_limit": 10,
            "request_made": "0",
            "request_remaining": "10"
        },
        {
            "organization_id": 2,
            "name": "IMB",
            "email": "akshay@imb.com",
            "subscription_plan": "custom",
            "monthly_limit": 5,
            "request_made": "4",
            "request_remaining": "1"
        }
    ]
}
```

Example of output - on internal error

`HTTP Status Code: 500`

```json
{
    "info": "Something went wrong. An error has occurred.",
    "data": null
}
```


#### Request for organization details - required api-key

Endpoint

```text
GET api/v1/request
```

--header 'x-api-key: yT4mCk25dC:1'
Headers

| Header      | Description                             | Options / Examples |
| ----------- | --------------------------------------- | ------------------ |
| `x-api-key` | Get api key by registering organization | `yT4mCk25dC:1`     |


Example of output - When the API key is not provided

`HTTP Status Code: 401`

```json
{
    "info": "Please add API key!",
    "data": null
}

```

Example of output - When API key is provided but invalid

`HTTP Status Code: 403`

```json
{
    "info": "Invalid API key!",
    "data": null
}

```

Example of output - When API key is provided and valid

`HTTP Status Code: 200`

```json
{
    "info": "Organization details fetched successfully!",
    "data": {
        "organizationID": 1,
        "organizationName": "IMB",
        "organizationEmail": "akshay@imb.com",
        "subscriptionPlan": "custom",
        "monthlyRequestLimit": 13,
        "remainingRequestCount": 7
    }
}

```

Example of output - When reached monthly limit

`HTTP Status Code: 429`

```json
{
    "info": "Too many requests.",
    "data": null
}

```

Example of output - on internal error

`HTTP Status Code: 500`

```json
{
    "info": "Something went wrong. An error has occurred.",
    "data": null
}
```

For more details check Postman Collection:
https://shrimant-peshawa-8.postman.co/workspace/NPAV-Projects~9557b0b2-2f86-495e-87a8-21bc44882372/collection/8082221-620fbe2e-13f7-45bc-9119-bc88a8a093b9?action=share&creator=8082221


### Live App

Base URL: https://subscription-limit.onrender.com

Example usage: https://subscription-limit.onrender.com/api/v1/dashboard


## TODO's
- Need to implement the _isAdmin_ check using middleware for Authorization purposes.
- We can add more features like.. *Payments, Subscriptions, and Notifications*.
- Add more useful routes for the dashboard and organization to enrich the experience.
- While generating _apiKey_ we can use _subdomain_ instead of _organizationID_.
  


## Thank you!! Happy Coding!!